{% extends 'base.html' %}
{% load static %}

{% block title %}Hacer Predicciones - Perceptrón Simple{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="bg-white dark:bg-accent-800 rounded-2xl shadow-xl border border-primary-100 dark:border-accent-700 overflow-hidden animate-fadeInUp">
        <div class="bg-gradient-to-r from-green-500 to-green-600 px-8 py-6">
            <h4 class="text-2xl font-bold text-white flex items-center">
                <i class="fas fa-calculator mr-3"></i>Hacer Predicciones
            </h4>
        </div>
        <div class="p-8">
            <!-- Información del perceptrón entrenado -->
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 border-l-4 border-blue-500 p-6 rounded-r-xl mb-8">
                <h6 class="text-lg font-semibold text-blue-800 dark:text-blue-200 mb-4 flex items-center">
                    <i class="fas fa-brain mr-2"></i>Perceptrón Entrenado: {{ training_record.nombre }}
                </h6>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <div class="flex justify-between items-center p-2 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                            <span class="text-blue-700 dark:text-blue-300 font-medium">Precisión:</span>
                            <span class="text-blue-800 dark:text-blue-200 font-semibold">{{ training_record.precision|floatformat:1 }}%</span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                            <span class="text-blue-700 dark:text-blue-300 font-medium">Entradas:</span>
                            <span class="text-blue-800 dark:text-blue-200 font-semibold">{{ training_record.columnas_entrada|join:", " }}</span>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="p-2 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                            <span class="text-blue-700 dark:text-blue-300 font-medium block mb-1">Pesos:</span>
                            <span class="text-blue-800 dark:text-blue-200 font-mono text-sm">
                                {% for weight in training_record.pesos_finales %}
                                    {{ weight|floatformat:3 }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                            <span class="text-blue-700 dark:text-blue-300 font-medium">Sesgo:</span>
                            <span class="text-blue-800 dark:text-blue-200 font-semibold">{{ training_record.sesgo_final|floatformat:3 }}</span>
                        </div>
                    </div>
                </div>
            </div>
                
            <!-- Formulario de predicción -->
            <form method="post" id="predictionForm" class="space-y-6">
                {% csrf_token %}
                
                <h5 class="text-xl font-semibold text-primary-800 dark:text-primary-200 mb-6 flex items-center">
                    <i class="fas fa-arrow-right mr-2"></i>Ingresa los Valores de Entrada
                </h5>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {% for field in form %}
                        <div class="space-y-2">
                            <label for="{{ field.id_for_label }}" class="block text-sm font-semibold text-accent-700 dark:text-accent-300">
                                <i class="fas fa-hashtag mr-2 text-primary-600"></i>{{ field.label }}
                            </label>
                            {{ field }}
                            {% if field.help_text %}
                                <p class="text-sm text-accent-600 dark:text-accent-400">{{ field.help_text }}</p>
                            {% endif %}
                            {% if field.errors %}
                                <div class="p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
                                    {% for error in field.errors %}
                                        <p class="text-red-700 dark:text-red-300 text-sm">{{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
                
                <div class="text-center pt-6">
                    <button type="submit" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-8 py-4 rounded-xl font-bold text-lg hover:from-green-600 hover:to-green-700 transition-all duration-200 flex items-center space-x-3 mx-auto shadow-lg hover:shadow-xl transform hover:scale-105">
                        <i class="fas fa-calculator text-xl"></i>
                        <span>Calcular Predicción</span>
                    </button>
                </div>
            </form>
                
            <!-- Resultado de la predicción -->
            {% if prediction %}
                <div class="bg-gradient-to-r from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-800/20 border-l-4 border-green-500 p-6 rounded-r-xl mt-8 animate-scaleIn">
                    <h5 class="text-lg font-semibold text-green-800 dark:text-green-200 mb-4 flex items-center">
                        <i class="fas fa-check-circle mr-2"></i>Resultado de la Predicción
                    </h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-3">
                            <h6 class="font-semibold text-green-700 dark:text-green-300">Valores de Entrada:</h6>
                            <div class="space-y-2">
                                {% for col, value in input_data.items %}
                                    <div class="flex justify-between items-center p-2 bg-green-50 dark:bg-green-900/30 rounded-lg">
                                        <span class="text-green-700 dark:text-green-300 font-medium">{{ col }}:</span>
                                        <span class="text-green-800 dark:text-green-200 font-semibold">{{ value }}</span>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="space-y-3">
                            <h6 class="font-semibold text-green-700 dark:text-green-300">Predicción:</h6>
                            <div class="text-center p-6 bg-white dark:bg-accent-800 rounded-xl shadow-lg">
                                <div class="text-4xl font-bold text-green-600 dark:text-green-400 mb-2">
                                    {% if prediction == 1 %}
                                        <i class="fas fa-check-circle mr-2"></i>1 (Verdadero)
                                    {% else %}
                                        <i class="fas fa-times-circle mr-2"></i>0 (Falso)
                                    {% endif %}
                                </div>
                                <p class="text-accent-600 dark:text-accent-400">
                                    El perceptrón predice: <strong>{{ prediction }}</strong>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
            </div>
        </div>
        
        <!-- Predicciones anteriores -->
        {% if previous_predictions %}
            <div class="mt-8">
                <div class="bg-white dark:bg-accent-800 rounded-2xl shadow-xl border border-primary-100 dark:border-accent-700 overflow-hidden animate-fadeInUp" style="animation-delay: 0.2s;">
                    <div class="bg-gradient-to-r from-accent-500 to-accent-600 px-8 py-6">
                        <h5 class="text-xl font-bold text-white flex items-center">
                            <i class="fas fa-history mr-3"></i>Predicciones Anteriores
                        </h5>
                    </div>
                    <div class="p-6">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b border-accent-200 dark:border-accent-600">
                                        {% for col in training_record.columnas_entrada %}
                                            <th class="text-left py-3 px-4 font-semibold text-accent-800 dark:text-accent-200">{{ col }}</th>
                                        {% endfor %}
                                        <th class="text-left py-3 px-4 font-semibold text-accent-800 dark:text-accent-200">Predicción</th>
                                        <th class="text-left py-3 px-4 font-semibold text-accent-800 dark:text-accent-200">Fecha</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-accent-200 dark:divide-accent-600">
                                    {% for pred in previous_predictions %}
                                        <tr class="hover:bg-accent-50 dark:hover:bg-accent-700/50 transition-colors duration-200">
                                            {% for value in pred.valores_entrada %}
                                                <td class="py-3 px-4 text-accent-700 dark:text-accent-300">{{ value }}</td>
                                            {% endfor %}
                                            <td class="py-3 px-4">
                                                <span class="px-3 py-1 rounded-full text-sm font-semibold {% if pred.salida_predicha == 1 %}bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300{% else %}bg-gray-100 text-gray-700 dark:bg-gray-900/30 dark:text-gray-300{% endif %}">
                                                    {{ pred.salida_predicha }}
                                                </span>
                                            </td>
                                            <td class="py-3 px-4 text-accent-700 dark:text-accent-300">{{ pred.fecha_prediccion|date:"d/m/Y H:i" }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        
        <!-- Información sobre el perceptrón -->
        <div class="mt-8">
            <div class="bg-white dark:bg-accent-800 rounded-2xl shadow-xl border border-primary-100 dark:border-accent-700 overflow-hidden animate-fadeInUp" style="animation-delay: 0.4s;">
                <div class="bg-gradient-to-r from-accent-500 to-accent-600 px-8 py-6">
                    <h5 class="text-xl font-bold text-white flex items-center">
                        <i class="fas fa-info-circle mr-3"></i>¿Cómo funciona la predicción?
                    </h5>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <h6 class="text-lg font-semibold text-accent-800 dark:text-accent-200 flex items-center">
                                <i class="fas fa-calculator mr-2 text-primary-500"></i>Fórmula de Predicción
                            </h6>
                            <div class="bg-accent-50 dark:bg-accent-700/50 rounded-xl p-4">
                                <p class="text-accent-700 dark:text-accent-300 mb-3">
                                    El perceptrón calcula:
                                </p>
                                <div class="bg-white dark:bg-accent-800 rounded-lg p-4 border border-accent-200 dark:border-accent-600">
                                    <code class="text-primary-600 dark:text-primary-400 font-mono text-lg">
                                        y = f(w₁x₁ + w₂x₂ + ... + wₙxₙ + b)
                                    </code>
                                </div>
                                <p class="text-accent-600 dark:text-accent-400 text-sm mt-3">
                                    Donde f() es la función escalón que devuelve 1 si el resultado ≥ 0, 0 en caso contrario.
                                </p>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <h6 class="text-lg font-semibold text-accent-800 dark:text-accent-200 flex items-center">
                                <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>Interpretación
                            </h6>
                            <div class="space-y-3">
                                <div class="flex items-start space-x-3">
                                    <div class="w-6 h-6 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                        <span class="text-green-600 dark:text-green-400 font-bold text-sm">1</span>
                                    </div>
                                    <div>
                                        <p class="text-accent-700 dark:text-accent-300 font-medium">Clase Positiva</p>
                                        <p class="text-accent-600 dark:text-accent-400 text-sm">El perceptrón predice que la clase es positiva</p>
                                    </div>
                                </div>
                                <div class="flex items-start space-x-3">
                                    <div class="w-6 h-6 bg-gray-100 dark:bg-gray-900/30 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                        <span class="text-gray-600 dark:text-gray-400 font-bold text-sm">0</span>
                                    </div>
                                    <div>
                                        <p class="text-accent-700 dark:text-accent-300 font-medium">Clase Negativa</p>
                                        <p class="text-accent-600 dark:text-accent-400 text-sm">El perceptrón predice que la clase es negativa</p>
                                    </div>
                                </div>
                                <div class="bg-primary-50 dark:bg-primary-900/20 rounded-lg p-3 border border-primary-200 dark:border-primary-800">
                                    <p class="text-primary-700 dark:text-primary-300 text-sm">
                                        <i class="fas fa-chart-line mr-1"></i>
                                        La precisión del <strong>{{ training_record.precision|floatformat:1 }}%</strong> indica qué tan confiable es la predicción
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('predictionForm');
    const inputs = form.querySelectorAll('input[type="number"]');
    
    // Validación en tiempo real
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            if (this.value === '' || isNaN(this.value)) {
                this.classList.add('border-red-500', 'bg-red-50', 'dark:bg-red-900/20');
                this.classList.remove('border-accent-300', 'dark:border-accent-600');
            } else {
                this.classList.remove('border-red-500', 'bg-red-50', 'dark:bg-red-900/20');
                this.classList.add('border-accent-300', 'dark:border-accent-600');
            }
        });
    });
    
    // Ejemplo de valores para compuerta AND
    const exampleButton = document.createElement('button');
    exampleButton.type = 'button';
    exampleButton.className = 'bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-lg font-semibold text-sm hover:from-blue-600 hover:to-blue-700 transition-all duration-200 flex items-center space-x-2 mt-4 shadow-lg hover:shadow-xl transform hover:scale-105';
    exampleButton.innerHTML = '<i class="fas fa-lightbulb"></i><span>Cargar Ejemplo AND</span>';
    exampleButton.onclick = function() {
        // Cargar ejemplo de compuerta AND
        const exampleValues = {
            {% for col in training_record.columnas_entrada %}
                '{{ col }}': 1{% if not forloop.last %},{% endif %}
            {% endfor %}
        };
        
        Object.keys(exampleValues).forEach((key, index) => {
            const input = document.querySelector(`input[name="${key}"]`);
            if (input) {
                input.value = exampleValues[key];
                input.classList.remove('border-red-500', 'bg-red-50', 'dark:bg-red-900/20');
                input.classList.add('border-accent-300', 'dark:border-accent-600');
            }
        });
        
        // Efecto visual de confirmación
        exampleButton.innerHTML = '<i class="fas fa-check"></i><span>¡Ejemplo cargado!</span>';
        exampleButton.classList.remove('from-blue-500', 'to-blue-600');
        exampleButton.classList.add('from-green-500', 'to-green-600');
        
        setTimeout(() => {
            exampleButton.innerHTML = '<i class="fas fa-lightbulb"></i><span>Cargar Ejemplo AND</span>';
            exampleButton.classList.remove('from-green-500', 'to-green-600');
            exampleButton.classList.add('from-blue-500', 'to-blue-600');
        }, 2000);
    };
    
    // Agregar el botón después del formulario
    const formContainer = form.parentElement;
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'text-center mt-6';
    buttonContainer.appendChild(exampleButton);
    formContainer.appendChild(buttonContainer);
});
</script>
{% endblock %}
